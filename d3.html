<html>

<head>
	<a name="tooltip" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

	<style>
		svg {
			background: #6DB0F2;
		}
		
		#boroughs {
			fill: #5082E5;
		}
		
		.circle {
			z-index: 0;
		}
		
		.d3-tip {
			font: 10px sans-serif;
			line-height: 1;
			font-weight: bold;
			padding: 12px;
			background: rgba(0, 0, 0, 0.8);
			color: #fff;
			border-radius: 2px;
		}
		/* Creates a small triangle extender for the tooltip */
		
		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 10px;
			width: 100%;
			line-height: 1;
			color: rgba(0, 0, 0, 0.8);
			content: "\25BC";
			position: absolute;
			text-align: center;
		}
		/* Style northward tooltips differently */
		
		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}
	</style>
</head>

<body>
	<svg><!-- This is the citi bike SVG -->
		<g transform="scale(.5)">
			<g>
				<g>
					<g>
						<path fill="#CCCCCC" d="M129,396v60c0,1.652,1.348,3,3,3s3-1.348,3-3v-60H129z" />
						<g>
							<path fill="#333333" d="M202.922,384c0.656,3.914,1.078,7.898,1.078,12c0,39.762-32.238,72-72,72s-72-32.238-72-72
					c0-13.125,3.574-25.406,9.715-36H56.227C51.012,370.934,48,383.109,48,396c0,46.312,37.688,84,84,84s84-37.688,84-84
					c0-4.078-0.398-8.074-0.961-12H202.922z" />
							<g>
								<g>
									<g>
										<path fill="#CCCCCC" d="M192,399H72c-1.652,0-3-1.348-3-3s1.348-3,3-3h120c1.652,0,3,1.348,3,3S193.652,399,192,399z" />
									</g>
								</g>
								<g>
									<g>
										<path fill="#CCCCCC" d="M174.422,441.422c-0.773,0-1.535-0.293-2.121-0.879l-84.844-84.844c-1.172-1.172-1.172-3.07,0-4.242
								s3.07-1.172,4.242,0l84.844,84.844c1.172,1.172,1.172,3.07,0,4.242C175.957,441.129,175.195,441.422,174.422,441.422z"
										/>
									</g>
									<g>
										<path fill="#CCCCCC" d="M89.578,441.422c-0.773,0-1.535-0.293-2.121-0.879c-1.172-1.172-1.172-3.07,0-4.242l84.844-84.844
								c1.172-1.172,3.07-1.172,4.242,0s1.172,3.07,0,4.242l-84.844,84.844C91.113,441.129,90.352,441.422,89.578,441.422z"
										/>
									</g>
								</g>
							</g>
							<g>
								<g>
									<path fill="#333333" d="M444,324c39.762,0,72,32.238,72,72s-32.238,72-72,72s-72-32.238-72-72S404.238,324,444,324 M444,312
							c-46.312,0-84,37.688-84,84s37.688,84,84,84s84-37.688,84-84S490.312,312,444,312L444,312z" />
								</g>
							</g>
							<g>
								<g>
									<g>
										<path fill="#CCCCCC" d="M470.848,452.66c-1.102,0-2.155-0.609-2.684-1.652l-53.695-107.32
								c-0.737-1.487-0.141-3.293,1.336-4.03c1.488-0.703,3.293-0.142,4.031,1.336l53.695,107.319
								c0.737,1.488,0.141,3.294-1.336,4.031C471.762,452.555,471.305,452.66,470.848,452.66z" />
									</g>
									<g>
										<path fill="#CCCCCC" d="M390.352,425.848c-1.102,0-2.155-0.608-2.684-1.651c-0.738-1.488-0.141-3.293,1.336-4.031
								l107.309-53.695c1.488-0.715,3.281-0.141,4.031,1.337c0.738,1.487,0.142,3.293-1.336,4.03l-107.309,53.695
								C391.266,425.742,390.809,425.848,390.352,425.848z" />
									</g>
								</g>
								<g>
									<g>
										<path fill="#CCCCCC" d="M500.93,417.961c-0.315,0-0.633-0.047-0.948-0.152l-113.837-37.922
								c-1.569-0.527-2.426-2.227-1.897-3.797s2.25-2.402,3.797-1.898l113.836,37.923c1.57,0.526,2.426,2.227,1.898,3.797
								C503.355,417.164,502.184,417.961,500.93,417.961z" />
									</g>
									<g>
										<path fill="#CCCCCC" d="M425.051,455.93c-0.315,0-0.633-0.047-0.949-0.151c-1.569-0.527-2.426-2.228-1.897-3.797
								l37.91-113.849c0.526-1.57,2.25-2.414,3.797-1.898c1.57,0.527,2.426,2.228,1.897,3.798L427.899,453.88
								C427.477,455.133,426.305,455.93,425.051,455.93z" />
									</g>
								</g>
							</g>
							<g>
								<g>
									<path fill="#5082E5" d="M270,396c9.926,0,18,8.074,18,18s-8.074,18-18,18s-18-8.074-18-18S260.074,396,270,396 M270,384
							c-16.57,0-30,13.43-30,30s13.43,30,30,30s30-13.43,30-30S286.57,384,270,384L270,384z" />
								</g>
							</g>
							<g>
								<g>
									<rect x="252" y="456" fill="#333333" width="36" height="12" />
								</g>
							</g>
							<g>
								<polygon fill="#5082E5" points="292.418,396 214.371,240 187.523,240 265.57,396 					" />
							</g>
						</g>
						<path fill="#6DB0F2" d="M156,384h59.051c-5.836-40.688-40.746-72-83.051-72c-33.492,0-62.32,19.641-75.809,48H156V384z" />
						<path fill="#6DB0F2" d="M114,360c9.938,0,18,8.062,18,18v6h24v-36h-48v12H114z" />
						<path fill="#FFFFFF" d="M132,342c0-3.305-2.695-6-6-6H90c-3.305,0-6,2.695-6,6l0,0c0,3.305,2.695,6,6,6h36
				C129.305,348,132,345.305,132,342L132,342z" />
						<path fill="#5082E5" d="M454.734,390.633L391.383,264h-26.836v0.012l-56.391,112.652c-1.828,4.312-6.094,7.336-11.062,7.336
				H160.969l75.516-75.516c4.688-4.688,4.688-12.281,0-16.969c-4.688-4.688-12.281-4.688-16.969,0l-96,96
				c-3.434,3.434-4.465,8.59-2.602,13.077C122.766,405.082,127.148,408,132,408h165.094c14.168,0,26.931-8.25,32.777-21.094
				l48.094-96.082l55.301,110.543c2.109,4.207,6.341,6.633,10.746,6.633c1.806,0,3.633-0.41,5.355-1.266
				C455.297,403.77,457.699,396.562,454.734,390.633z" />
						<path d="M401.509,337.889l-5.416-10.826c-3.37,2.35-6.558,4.938-9.544,7.744l5.625,11.243
				C395.045,343.07,398.165,340.337,401.509,337.889z" />
						<g>
							<path fill="#333333" d="M371.32,223.898C365.18,211.629,352.84,204,339.117,204H300v24h39.117c4.582,0,8.695,2.543,10.733,6.633
					L364.547,264h26.836L371.32,223.898z" />
						</g>
					</g>
					<path fill="#FF5967" d="M181.734,180c26.812-30.281,65.367-48,106.266-48c40.899,0,79.453,17.719,106.266,48h59.707l-9.375-13.617
			C409.066,114.797,350.52,84,288,84c-62.52,0-121.066,30.797-156.598,82.383L122.027,180H181.734z" />
				</g>
				<path opacity="0.2" enable-background="new    " d="M252,414v23.859c3.504,2.647,7.535,4.629,12,5.53v-12.491
		C257.027,428.414,252,421.816,252,414z" />
				<polygon opacity="0.2" enable-background="new    " points="214.371,240 187.523,240 197.941,260.836 222.305,255.855 	" />
				<g>
					<g>
						<path fill="#333333" d="M240,240l-57.574,11.754C181.641,251.906,180.832,252,180,252c-6.633,0-12-5.367-12-12s5.367-12,12-12h54
				c3.316,0,6,2.684,6,6V240z" />
					</g>
				</g>
				<g>
					<g>
						<path fill="#CCCCCC" d="M264,456v-36c0-3.316,2.684-6,6-6l0,0c3.316,0,6,2.684,6,6v36H264z" />
					</g>
				</g>
			</g>
			<path fill="#333333" d="M396,228c-6.633,0-12-5.367-12-12l0,0c0-6.633,5.367-12,12-12h24v24H396z" />
			<path d="M69.715,360H56.227c-1.837,3.854-3.395,7.861-4.65,12h12.58C65.651,367.811,67.515,363.795,69.715,360z" />
			<path d="M202.985,408c-0.693,4.13-1.734,8.14-3.099,12h12.601c1.163-3.891,2.052-7.897,2.642-12H202.985z" />
		</g>

	</svg>

	<script>
		var width = 1024,
			height = 768;
		var svg = d3.select("svg")
			.attr("width", width)
			.attr("height", height);
		//projection is a function object that takes coordinates
		//and maps them to the square bounds of the screen.
		//'rotate' and 'center' are coordinates grabbed by scrolling
		//manhattan into view in Google maps and hacking the URL.
		//'scale' and 'precision' are the result of trial and error.
		var projection = d3.geo.albers()
			.scale(300000)
			.rotate([73.969,0])
			.center([0,40.759])
			.translate([width/2,height/2])
			.precision(.0001);
		//this is the tooltip shown when you mouseover a station.
		var tip = d3.tip()
			.attr('class', 'd3-tip')
			.offset(function(stationData) {
				console.log(stationData)
  				return projection([stationData.longitude,stationData.latitude])
			})
			.html(function(d) {
				return "<strong>Name:</strong> <span style='color:red'>" + d.stationName + "</span>";
			});
		//another function object which applies the projection to 
		//the various borough outlines 
		var path = d3.geo.path()
			.projection(projection);
		
		svg.call(tip);
		
		//initialise the SVG elements for the land and the bike 
		//spots here. SVG doesn't have a z-order model so doing
		//this in the callback code from json reads introduces
		//a race condition. We want the spots to be on top of the land.
		var land = svg.append("g");
		var spots = svg.append("g");
		
		//read the borough boundary coordinates from a json document.
		var boroughs = d3.json("nyc-boroughs.json", function(error, nyb) {
			if (error) throw error;
			
			//create an SVG group element for the boroughs
			land.append("g")
				.attr("id", "boroughs")
				.selectAll(".state")
				.data(nyb.features)
				//for each element create a path with the appropriate name -
				//this would allow us to style the five boroughs differently.
				.enter().append("path")
				.attr("class", function(d){return d.properties.borough;})
				//call the path function on the coordinates to map them 
				//correctly to screen coordinates
				.attr("d", path);
		});
		
		//same for the citibike spots. This isn't in a well-known format,
		//however, so we have to parse the data ourselves. Luckily, D3
		//is really good at doing this.
		d3.json("citibike.json", function(error, data){
			if(error) return console.error(error);
			
			//'y' is a function which returns a colour between red and
			//green for inputs between 0 and 1. Cool, right?!
			var y=d3.scale.linear().domain([0,1]).range(["red","green"]);
			
			spots.selectAll("circles.points")
				//for each element in 'stationBeanList'
				.data(data.stationBeanList)
				.enter()
				//create an SVG circle element
				.append("circle")
				//with a radius proportionate to the number of available docks.
				.attr("r", function(stationData){return stationData.availableDocks / 40})
				//manually put the dot in the right place. Remember to use the projection
				//function to map the global coordinates to screen coordinates.
				.attr("transform", function(stationData){
					return "translate(" + projection([stationData.longitude,stationData.latitude]) + ")"
				})
				//colour the circle between red and green to show how full the station is
				.attr("fill", function(stationData){return y(stationData.availableDocks / stationData.totalDocks)})
				//show and hide the station name on mouseover.
      			.on('mouseover', tip.show)
      			.on('mouseout', tip.hide)
			});
	</script>
</body>

</html>